#嵌入式调试思想-模块化
#Cubemx生成覆盖问题

# 嵌入式调试思想：
1. 模块化调试，分步走
因为CubeMX+VsCode+Keil assistant联调的不确定性
	1. 例如，想要用定时器控制灯的亮灭（定时器软定时非堵塞+调用中断），可以先生成TIM的波形，用逻辑分析仪验证；
	2. 验证正确后，继续在基础代码上添加任务部分（即，灯光控制与调用的配置）

# Cubemx生成覆盖问题
1. ”cubemx生成不是会覆盖掉文件夹吗？“
	1. 你问得特别好，这确实是很多初学者第一次被 CubeMX“坑”的地方。你问得特别好，这确实是很多初学者第一次被 CubeMX“坑”的地方。

# stm32串口回传、通讯方式选择
1. 串口中断实现回传+反馈（pc13）
# 问题
1. 购买的"Muse无线串口"通讯格式，老板说是”基于WIFI的，TCP带重传“
2. 电脑通过无线串口主端发送数据，逻辑分析仪抓取从端的tx,rx，发现tx有原始数据，偶尔对应的tx数据起始电平拉低，rx有个短暂的下拉变回上拉的过程；1、为什么是tx出现数据？2、为什么rx跳变不是每次都有？([无线模块电平跳变情况](https://chatgpt.com/c/68d48db0-ddb0-8321-bc73-f27acaf3c026))


**CubeMX 的重新生成规则：**

1. **不会整个覆盖文件夹**
   CubeMX 在重新生成代码时，只会重新生成它“管理”的文件，并且**保留 `/* USER CODE BEGIN ... */ ... /* USER CODE END ... */` 区域里的内容**。

   * 例如 `main.c`、`tim.c`、`gpio.c` 等，都会重新生成初始化代码，但用户代码区域会被保留。
   * 新加外设时，会在相应文件插入新的初始化函数，不会删除已有的用户代码。

2. **会覆盖非用户区域**
   如果你把自己的代码写在了 `/* USER CODE BEGIN ... */` 以外的地方，下一次生成时 CubeMX 会直接重写这些部分，你的代码就丢了。

3. **不会碰自建文件**
   如果你自己建了一个 `bsp_tim.c`、`bsp_tim.h`，CubeMX 完全不会管这些文件，它只负责生成自己的文件，不会删除整个工程文件夹。

---

✅ **所以我刚才说的那种做法安全的原因是：**

* 我建议你把回调写在单独的 `bsp_tim.c`，CubeMX 不会动它。
* 即便你放在 `tim.c` 里，只要写在 `/* USER CODE BEGIN 4 */` 和 `/* USER CODE END 4 */` 之间，CubeMX 下次生成时也会保留。

---

🔑 **最佳实践：**

* **驱动代码：** 让 CubeMX 生成在 `tim.c`、`gpio.c` 里。
* **应用代码：** 放在 `main.c` 的用户区域，或者放到你自己建的文件里。
* **不要改动 HAL 库文件或自动生成的非用户区域**，否则下一次点击“Generate Code”就会被覆盖。

---

要不要我帮你整理一份 **CubeMX 代码生成规则 + 常见“安全写代码位置”对照表**，方便你以后不用担心被覆盖？这样你知道该把逻辑写在哪个文件、哪个区域才不会丢失。
好的，给你整理一份非常实用的 **CubeMX 代码生成规则 + 安全写代码位置对照表**，以后你直接对照就能知道该把代码放哪儿，避免被覆盖。

---

# 🛡️ CubeMX 代码生成安全指南

## 1. 代码生成规则

| 区域/文件类型                                                            | CubeMX 生成时行为 | 说明                                                |
| ------------------------------------------------------------------ | ------------ | ------------------------------------------------- |
| **自动生成文件（xxx.c / xxx.h）**                                          | 会重写非用户区域     | 如 `main.c`、`tim.c`、`gpio.c`，CubeMX 生成的初始化代码会更新。   |
| **用户代码区（`/* USER CODE BEGIN ... */ ... /* USER CODE END ... */`）** | 保留           | 这是官方预留的安全区，CubeMX 不会动里面的代码。                       |
| **自己新建的文件**                                                        | 不会修改         | 你建的 `bsp_xxx.c`、`bsp_xxx.h` 等文件 CubeMX 完全不会碰。     |
| **HAL 库文件（Drivers/HAL/…）**                                         | 不会修改         | 除非你手动改，CubeMX 不会生成或覆盖 HAL 库。                      |
| **工程配置文件 (.ioc)**                                                  | 更新           | 这个是 CubeMX 工程文件，保存所有外设配置。不要手动改，直接用 CubeMX GUI 修改。 |

---

## 2. 安全写代码位置对照表

| 文件/位置                                     | 推荐用途            | 安全性    | 说明                                       |
| ----------------------------------------- | --------------- | ------ | ---------------------------------------- |
| **main.c - USER CODE BEGIN 0/1/2/3**      | 全局变量、初始化、循环逻辑   | ✅ 安全   | 推荐放应用层代码，如任务调度、用户逻辑                      |
| **tim.c - USER CODE BEGIN 0/4**           | 定时器中断回调、扩展函数    | ✅ 安全   | 可直接写 `HAL_TIM_PeriodElapsedCallback` 等回调 |
| **gpio.c - USER CODE BEGIN 0**            | GPIO 扩展函数、初始化修改 | ✅ 安全   | 可以加你自己的 pin 初始化函数                        |
| **stm32f1xx\_it.c - USER CODE BEGIN/END** | 中断服务函数扩展        | ✅ 安全   | 写 ISR 回调时，放在用户区域                         |
| **自建文件 bsp\_xxx.c/h**                     | 驱动封装            | ✅ 最安全  | 完全独立，不受 CubeMX 影响，推荐放复杂逻辑                |
| **CubeMX 生成的非用户区域**                       | ❌ 禁止手动改         | ⚠️ 风险高 | 下次 Generate Code 会被覆盖，修改丢失               |

---

## 3. 推荐实践

✅ **驱动-应用分离**

* 让 CubeMX 负责外设初始化
* 把业务逻辑、控制算法写在 `bsp_xxx.c`、`app_xxx.c` 等自建文件里
* 在 `main.c` 用户区域调用你的函数

✅ **回调函数放在 USER CODE 区域**

* 例如定时器中断：

  ```c
  /* USER CODE BEGIN 4 */
  void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
  {
      if(htim->Instance == TIM2)
      {
          HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_13);
      }
  }
  /* USER CODE END 4 */
  ```

✅ **随时保存 .ioc 文件**

* 如果工程损坏，可以重新生成代码，用户区域仍然会保留。

---

## 4. 典型“坑点”提醒

| 坑点            | 原因            | 解决方案                                   |
| ------------- | ------------- | -------------------------------------- |
| 写在非用户区域被覆盖    | CubeMX 重生成覆盖了 | 总是写在 `USER CODE` 区域或独立文件               |
| 修改 HAL 库文件后丢失 | 升级 HAL 库或重新生成 | 不要直接改 HAL，改驱动时用用户回调重写                  |
| 新建文件不添加到工程    | CubeMX 生成不识别  | 新建文件后手动添加到工程（Keil、VSCode、STM32CubeIDE） |

---

要不要我帮你画一张 **代码结构示意图（层次图）**，直观展示 CubeMX 生成层、HAL 层、BSP 层、应用层的关系，让你清楚哪里能写、哪里不能写？这样你看一眼就知道文件结构怎么规划。
