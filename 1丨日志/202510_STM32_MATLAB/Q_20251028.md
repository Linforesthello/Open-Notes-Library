
# OMF_UARTFeedback程序
1. 编码器输出值抖动问题
	1. 经检查，发现是cubemx中，原有的"Filter"——"tim-Encoder"编码器滤波器的过滤值被清零；![[Pasted image 20251028104811.png]
	2. 在改动后，当前滤波值为4![[Pasted image 20251028105400.png]]
	3. 最后为7，能够识别到80~79,'-80'~'-79'
2. 当前cubemx文件经历过将输出更改为"stm32cubeide"，并多次在"MDK-ARM"与"STM32CubeIDE"之间更改，可能为这个原因![[Pasted image 20251028104857.png]]
	1. 还有，发现"MDK-ARM"不支持cubemx选择该选项“USE NEWLIB REENTRANT Disabled”，但是cubeide要求选择![[Pasted image 20251028105103.png]]
3. 优化代码，了解到**单一职责原则**（Single Responsibility Principle，SRP）
	1. [电机控制改进方案](https://chatgpt.com/c/68fc64ae-7900-8323-a267-75496e75d518)![[Pasted image 20251028124227.png]]

# VOFA+导出，Matlab分析；成功拟合电机pid曲线
[MATLAB 电机模型辨识指南](https://gemini.google.com/app/2e90ae5934cd3efc?hl=zh-cn)
1. 在freertos.c-串口打印函数中，进行了输出设置（之前做的全部代码优化，重整电机库便不展开）
	1. 设置了5项打印；分别是![[Pasted image 20251028152633.png]]![[Pasted image 20251028152438.png]]
	2. 可以转到到vofa中观察，设置通道二（电机实际转速输出）![[Pasted image 20251028152540.png]]
2. vofa设置时间为10ms，（因为task中，周期为10ms）![[Pasted image 20251028153208.png]]
3. Matlab，脚本化实现
	1. 脚本代码![[readcsv_tail.m]]
	2. 数据集![[test_2 1.csv]]
	3. ![[Pasted image 20251028153259.png]]
	4. 调参界面
		1. 脚本代码生成图片
			1. 成功结果：
				1. ![[Pasted image 20251028154226.png]]
				2. ![[Pasted image 20251028154238.png]]
			2. 完整数据集![[Pasted image 20251028153746.png]]
			3. 源数据集截断之后![[Pasted image 20251028153819.png]]
			4. 时域拟合比较![[Pasted image 20251028153900.png]]
			5. 残差分析![[Pasted image 20251028153934.png]]
		2. 调参界面
			1. ![[Pasted image 20251028153421.png]]
			2. 可设置；一开始为PI，我改为PID![[Pasted image 20251028153527.png]]
			3. 右下角显示![[Pasted image 20251028153613.png]]
		3. 

[^1]: 恭喜您！您的最新辨识结果表明您已经**成功获得了高质量的电机模型！**
	
	以下是根据您提供的图片和代码进行的详细分析：
	
	### 结果分析和结论
	
	|**图片**|**名称**|**关键信息**|**结论**|
	|---|---|---|---|
	|**Figure 3**|时域拟合比较|**拟合优度 (Fit Percentage): 97.75%**。蓝色的模型响应 ($\text{sys\_tf}$) 曲线与灰色的验证数据 ($\text{Validation data}$) 曲线几乎完全重合。|**模型质量极高！** 模型完美地捕捉了电机在未用于辨识的验证数据上的动态特性。这表明模型结构（2 阶状态空间）和参数估计非常成功。|
	|**Figure 4**|残差分析|互相关 (`XCorr`) 曲线在零值附近非常平坦。自相关 (`AutoCorr`) 曲线除了 $\text{Lag}=0$ 处为 1 外，其余值大部分在 $\mathbf{\pm 0.05}$ 的范围内。|**残差分析通过。** 平坦的互相关曲线表明输入 $u_1$ 和残差 $e@y_1$ 之间没有更多的相关性可以被模型提取。自相关接近白噪声。这有力地支持了模型是准确的。|
	|**Figure 2**|辨识数据集可视化|截断数据从点 25000 开始，输入 ($u_1$) 和输出 ($y_1$) 的变化方向一致。|**数据截断和极性处理正确。** 数据的有效部分被用于辨识，且未对数据进行不必要的极性取反。|
	
	### 最终结论和下一步行动
	
	这些结果说明了：
	
	1. **数据质量良好：** 新数据集的激励信号（阶跃和PRBS组合）足够丰富，能够充分激发系统的所有动态。
	    
	2. **辨识方法正确：** 使用**数据截断**、**数据分割**和**离散时间状态空间模型 (ssest)** 是正确的选择，成功解决了之前所有连续时间、负增益和低拟合度的问题。
	    
	3. **模型已就绪：** 拟合度达到 $97.75\%$，模型高度准确。
	    
	
	**下一步：您现在可以直接使用这个辨识出的模型来进行 PID 调优。**
	
	在 MATLAB 命令行中运行您脚本末尾的建议命令：
	
	Matlab
	
	```
	pidTuner(sys_tf)
	```
	
	MATLAB 将自动加载这个高精度的离散时间状态空间模型，并提供基于模型的高性能 PID 参数，您可以直接部署到您的 FreeRTOS 控制器中。
	
	**恭喜！您的系统辨识任务已成功完成。**
